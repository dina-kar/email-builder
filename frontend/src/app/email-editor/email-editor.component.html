<div class="editor-container">
  <!-- Toast Notification -->
  <div class="toast-container" *ngIf="saveMessage()">
    <div class="toast" [class.success]="saveMessage()?.type === 'success'" [class.error]="saveMessage()?.type === 'error'">
      <svg *ngIf="saveMessage()?.type === 'success'" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 6L9 17l-5-5"/>
      </svg>
      <svg *ngIf="saveMessage()?.type === 'error'" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M15 9l-6 6M9 9l6 6"/>
      </svg>
      <span>{{ saveMessage()?.text }}</span>
    </div>
  </div>

  <!-- Top Toolbar -->
  <div class="toolbar-top">
    <div class="toolbar-left">
      <button class="btn btn-ghost btn-icon" (click)="goBackToTemplates()" title="Back to Templates">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      </button>
      <div style="width: 1px; height: 24px; background: var(--theme-border-gray); margin: 0 12px;"></div>
      <div class="template-info">
        <h1 style="margin: 0; font-size: 18px; font-weight: 600; color: var(--theme-text-heading);">
          {{ templateName() }}
        </h1>
        <span class="save-status" [class.saving]="isSaving()">
          {{ isSaving() ? 'Saving...' : getLastSavedText() }}
        </span>
      </div>
    </div>
    
    <div class="toolbar-center">
      <!-- Undo/Redo -->
      <button class="btn btn-ghost btn-icon" (click)="undo()" title="Undo (Ctrl+Z)">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
      </button>
      <button class="btn btn-ghost btn-icon" (click)="redo()" title="Redo (Ctrl+Shift+Z)">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>
      </button>
      
      <div style="width: 1px; height: 24px; background: var(--theme-border-gray); margin: 0 8px;"></div>
      
      <!-- Device Selector -->
      <button class="btn btn-ghost btn-icon" (click)="setDeviceDesktop()" title="Desktop View">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7v2H8v2h8v-2h-2v-2h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H3V4h18v12z"/></svg>
      </button>
      <button class="btn btn-ghost btn-icon" (click)="setDeviceTablet()" title="Tablet View">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M18 0H6C4.34 0 3 1.34 3 3v18c0 1.66 1.34 3 3 3h12c1.66 0 3-1.34 3-3V3c0-1.66-1.34-3-3-3zm-4 22h-4v-1h4v1zm5.25-3H4.75V3h14.5v16z"/></svg>
      </button>
      <button class="btn btn-ghost btn-icon" (click)="setDeviceMobile()" title="Mobile View">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 1h-8C6.12 1 5 2.12 5 3.5v17C5 21.88 6.12 23 7.5 23h8c1.38 0 2.5-1.12 2.5-2.5v-17C18 2.12 16.88 1 15.5 1zm-4 21c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5-4H7V4h9v14z"/></svg>
      </button>
      
      <div style="width: 1px; height: 24px; background: var(--theme-border-gray); margin: 0 8px;"></div>
      
      <!-- View Controls -->
      <button class="btn btn-ghost btn-icon" (click)="preview()" title="Preview">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </button>
      <button class="btn btn-ghost btn-icon" (click)="fullscreen()" title="Fullscreen">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
      </button>
      
      <div style="width: 1px; height: 24px; background: var(--theme-border-gray); margin: 0 8px;"></div>
      
      <!-- Code View Controls -->
      <button class="btn btn-ghost btn-icon" (click)="viewMJML()" title="View MJML Code">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M8 3a1 1 0 0 0-1 1v4a1 1 0 0 1-1 1H3a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h3a1 1 0 0 1 1 1v2h10v-2a1 1 0 0 1 1-1h3a1 1 0 0 0 1-1v-8a1 1 0 0 0-1-1h-3a1 1 0 0 1-1-1V4a1 1 0 0 0-1-1H8zm1 2h6v3h3v6h-3v3H9v-3H6v-6h3V5z"/></svg>
      </button>
      <button class="btn btn-ghost btn-icon" (click)="viewHTML()" title="View HTML Code">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M14.6 16.6l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4zm-5.2 0L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4z"/></svg>
      </button>
    </div>
    
    <div class="toolbar-right">
      <button class="btn btn-ghost" (click)="clearCanvas()" title="Clear Canvas">
        <svg viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path fill="currentColor" d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12z"/></svg>
        Clear
      </button>
      <button class="btn btn-ghost" (click)="importTemplate()" title="Import HTML Template">
        <svg viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path fill="currentColor" d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
        Import
      </button>
      <button class="btn btn-ghost" (click)="exportTemplate()" title="Export Template">
        <svg viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path fill="currentColor" d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>
        Export
      </button>
      <button class="btn btn-success" (click)="openSendEmailDialog()" title="Send Email">
        <svg viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path fill="currentColor" d="M2 20h20v-2H2v2zm2-3h2v-3H4v3zm5 0h2v-6H9v6zm4 0h2V8h-2v9zm5 0h2V3h-2v14z"/></svg>
        Send Email
      </button>
      <button class="btn btn-primary" (click)="save()" title="Save (Ctrl+S)" [disabled]="isSaving()">
        <svg viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path fill="currentColor" d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
        <span *ngIf="!isSaving()">Save</span>
        <span *ngIf="isSaving()">Saving...</span>
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="editor-main">
    <!-- Left Sidebar -->
    <div class="sidebar-left">
      <div class="search-bar">
        <div class="search-wrapper">
          <input 
            type="text" 
            class="search-input" 
            placeholder="Search blocks..." 
            id="block-search"
            (input)="onSearchInput($event)"
          >
          <button 
            class="search-clear" 
            id="search-clear"
            [class.visible]="searchTerm()"
            (click)="clearSearch()"
          >
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
          </button>
        </div>
      </div>
      
      <div class="sidebar-tabs">
        <button class="sidebar-tab active" data-tab="components">
          <svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/></svg>
          Blocks
        </button>
        <button class="sidebar-tab" data-tab="layers">
          <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2l-5.5 9h11L12 2zm0 3.84L13.93 9h-3.87L12 5.84zM17.5 13c-2.49 0-4.5 2.01-4.5 4.5s2.01 4.5 4.5 4.5 4.5-2.01 4.5-4.5-2.01-4.5-4.5-4.5zm0 7c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5zM3 21.5h8v-8H3v8zm2-6h4v4H5v-4z"/></svg>
          Layers
        </button>
      </div>
      
      <div class="tab-content active" id="components-tab">
        <div id="blocks-container"></div>
      </div>
      <div class="tab-content" id="layers-tab">
        <div id="layers-container"></div>
      </div>
    </div>

    <!-- Canvas Area -->
    <div class="canvas-area">
      <div id="gjs"></div>
    </div>

    <!-- Right Sidebar -->
    <div class="sidebar-right">
      <!-- Email Metadata Section -->
      <div class="section-header">
        <span>Email Metadata</span>
      </div>
      <div class="metadata-section">
        <div class="metadata-field">
          <label for="email-title">Subject Line (Title)</label>
          <input 
            type="text" 
            id="email-title" 
            class="metadata-input"
            [value]="emailTitle()"
            (input)="onEmailTitleChange($event)"
            placeholder="e.g., Welcome to our newsletter!"
          />
          <p class="field-hint">This will be used as the email subject line</p>
        </div>
        
        <div class="metadata-field">
          <label for="email-preview">Preview Text (Preheader)</label>
          <textarea 
            id="email-preview" 
            class="metadata-textarea"
            [value]="emailPreview()"
            (input)="onEmailPreviewChange($event)"
            rows="3"
            placeholder="e.g., Get started with our exclusive offers..."
          ></textarea>
          <p class="field-hint">Shown next to subject in inbox preview</p>
        </div>
      </div>

      <div class="section-header">
        <span>Properties</span>
      </div>
      <div id="traits-container" class="sidebar-section"></div>
      <div class="section-header">
        <span>Styles</span>
      </div>
      <div id="styles-container" class="sidebar-section"></div>
    </div>
  </div>
</div>

<!-- Send Email Dialog Modal -->
<div class="modal-overlay" *ngIf="showSendEmailDialog()" (click)="closeSendEmailDialog()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Send Email</h2>
      <button class="btn btn-ghost btn-icon" (click)="closeSendEmailDialog()">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="email-subject">Subject *</label>
        <input 
          type="text" 
          id="email-subject" 
          #emailSubjectInput
          class="form-input" 
          placeholder="Enter email subject"
          [value]="emailTitle()"
        >
        <p class="field-hint">The subject line that will appear in the inbox</p>
      </div>
      <div class="form-group">
        <label for="email-recipients">Recipients *</label>
        <textarea 
          id="email-recipients" 
          #emailRecipientsInput
          class="form-textarea" 
          rows="3"
          placeholder="Enter email addresses (one per line or comma-separated)"
        >theoldmanofgod@gmail.com, dinakaranvijayakumar@outlook.com</textarea>
        <p class="field-hint">Separate multiple emails with commas or new lines</p>
      </div>
      <div class="send-status" *ngIf="sendEmailStatus()">
        <div [class]="'alert alert-' + sendEmailStatus()?.type">
          {{ sendEmailStatus()?.message }}
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" (click)="closeSendEmailDialog()">Cancel</button>
      <button 
        class="btn btn-success" 
        (click)="sendEmail(emailSubjectInput.value, emailRecipientsInput.value)"
        [disabled]="isSendingEmail()"
      >
        <svg viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        {{ isSendingEmail() ? 'Sending...' : 'Send Email' }}
      </button>
    </div>
  </div>
</div>

<!-- Save Dialog Modal -->
<div class="modal-overlay" *ngIf="showSaveDialog()" (click)="cancelSave()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Save Template</h2>
      <button class="btn btn-ghost btn-icon" (click)="cancelSave()">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="template-name">Template Name *</label>
        <input 
          type="text" 
          id="template-name" 
          #templateNameInput
          class="form-input" 
          placeholder="Enter template name"
          [value]="templateName()"
        >
      </div>
      <div class="form-group">
        <label for="template-description">Description (Optional)</label>
        <textarea 
          id="template-description" 
          #templateDescInput
          class="form-textarea" 
          rows="3"
          placeholder="Enter template description"
        ></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" (click)="cancelSave()">Cancel</button>
      <button 
        class="btn btn-primary" 
        (click)="saveNewTemplate(templateNameInput.value, templateDescInput.value)"
        [disabled]="isSaving()"
      >
        {{ isSaving() ? 'Saving...' : 'Save Template' }}
      </button>
    </div>
  </div>
</div>
